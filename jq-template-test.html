<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>testing</title>

<link type="text/css" rel="stylesheet" media="all" href="jq-template-test.css" />

<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.js"></script>
<script src="js/lib/jquery.tmpl.ca165f.js"></script>
<script src="js/eolapi.js"></script>
<script src="js/layout/treemap.js"></script>
<script src="js/layout/pivotTreemap.js"></script>
<script src="js/sources/eolTemplateHelper.js"></script>
<script>
	var api = new EolApi(),
	templateHelper = new EolTemplateHelper,
	viewDepth = 2,
	nodeOps = new NodeOps(),
	layout = squarifiedTreemap;

	HTMLImageElement.prototype.resizeToFill = function resizeToFill() {
		var jq = jQuery(this),
			container = this.parentElement,
			imageAR = this.naturalWidth / this.naturalHeight,
			containerAR = container.clientWidth / container.clientHeight,
			overlapPercent;

		if (imageAR >= containerAR) {
			//image aspect ratio is wider than container: fit height
			jq.css("top", "auto");
			jq.css("height", "100%");

			//center overlapping width
			jq.css("width", "auto");
			overlapPercent = 50 * (imageAR / containerAR - 1);
			jq.css("left", -overlapPercent + "%");
		} else {
			//image aspect ratio is taller than container: fit width
			jq.css("left", "auto");
			jq.css("width", "100%");

			//center overlapping height
			jq.css("height", "auto");
			overlapPercent = 50 * (containerAR / imageAR - 1);
			jq.css("top", -overlapPercent + "%");
		}
	};
	
	function NodeOps() {
		var that = this;
		this.getArea = eolSubtreeSize;
		this.getDisplayArea = function sqrtArea(node) {
			return Math.sqrt(that.getArea(node));
		};
		this.setBounds = setDOMBounds;
		this.getBounds = getDOMBounds;
		this.getChildren = getDOMChildren;
		this.getLayoutBounds = getDOMLayoutBounds;
	}

	jQuery(document).ready(function() {
		jQuery.get('templates/_nested.tmpl.html', function(templates) {
			jQuery('head').append(templates);
			viewIncremental('28670753', viewDepth, jQuery("#container"));
			//view('28670753', viewDepth, jQuery("#container"));
		});
	});

	jQuery("div.node, a.breadcrumb.ancestor").live("click", function(){
		var container = jQuery("#container").empty();
		viewIncremental(this.id, viewDepth, container);
		return false; //only innermost node handles event
	});

	jQuery(window).resize(function resize() {
		//trigger resize on the layout root
		jQuery("div.root").resize();
		return false;
	});

	jQuery("div.node").live("resize", function () {
		//redo layout
		layout.doLayout(this, nodeOps, false);
		jQuery("div.body > img.resizable", this).resize();
		return false;
	});

	jQuery("img.resizable").live("resize", function () {
		this.resizeToFill();
		return false;
	});

	/* gets the hierarchy_entries to some depth and displays them all */
	function view(id, depth, container) {
		api.hierarchySubtree(id,depth).
				done(function(json){
					var content = jQuery('#root').tmpl(json, templateHelper);
					
					content.appendTo(container);
					layout.doLayout(content[0], nodeOps);
				});
	}

	/* gets the hierarchy_entries one level at a time and only fetches children
	 * if the parent is not too small. Nodes are displayed as soon as they
	 * are fetched.
	 */
	function viewIncremental(id, depth, container) {
		api.hierarchy_entries(id).done(function(json){
			var root = jQuery('#root').tmpl(json, templateHelper);
			container.append(root);
			fetchChildren(root[0], depth);
		});
	}

	function fetchChildren(node, depth) {
		var childContainer = jQuery(node).children("div.body").first();
		childContainer.empty();
		
		//TODO check if node is big enough
		if (depth > 0 && childContainer.width() > 50 && childContainer.height() > 50) {
			api.hierarchySubtree(node.id, 1).done(function(json) {
				json.children.sort(function (a, b) { return a.scientificName.localeCompare(b.scientificName) });
				var children = jQuery('#node').tmpl(json.children, templateHelper);
						
				childContainer.append(children);
				layout.doLayout(node, nodeOps);
						
				children.filter("div.node").each(function() {
					fetchChildren(this, depth - 1);
				});
			});
		} else {
			//TODO display image
			//var image = jQuery("<img class='resizable'>").appendTo(childContainer);
			var image = jQuery(templateHelper.getImage(node)).appendTo(childContainer);
			//image.attr("src", "images/eol_logo.gif");
			image.load(function() {
				//assuming no scaling has been done yet, setting 'natural' dims for browsers that don't set them
				this.naturalWidth = this.naturalWidth || this.width;
				this.naturalHeight = this.naturalHeight || this.height;

				if (jQuery(this).hasClass("resizable")) {
					this.resizeToFill();
				}
			});
		}
	}
	
	function eolSubtreeSize(node) {
		return jQuery(node).tmplItem().data.total_descendants + 1;
	};

	function sqrtSubtreeSize(node) {
		return Math.sqrt(eolSubtreeSize(node));
	};
	
	function logBounds(node, bounds) {
		console.log(node + ":" + bounds.x + "," + bounds.y + "," + bounds.width + "," + bounds.height);
	}

	function setDOMBounds(node, bounds) {
		bounds = {
			x:Math.round(bounds.x),
			y:Math.round(bounds.y),
			width:Math.round(bounds.width),
			height:Math.round(bounds.height)
		}
		var borderWidth = 1;
		//TODO check actual border width once at startup
		
		node = jQuery(node); //wrap the bare HTMLDivElement in a jQuery before setting bounds
		node.css({'left':bounds.x, 'top':bounds.y});
		node.height(bounds.height - 2 * borderWidth);
		node.width(bounds.width - 2 * borderWidth);
		node.resize();
	}

	function getDOMBounds(node) {
		//TODO
		throw "getDOMBounds not yet implemented";
	}

	//takes a DOM div.node and returns its div.node children (not the immediate DOM children, which would just be the header and body container)
	function getDOMChildren(node) {
		var childContainer = jQuery(node).children("div.body").first();
		return jQuery.makeArray(childContainer.children("div.node"));
	}

	//takes a DOM div.node and returns the bounds of its child container
	function getDOMLayoutBounds(node) {
		var childContainer = jQuery(node).children("div.body").first();
		return {
			x: 0,
			y: 0,
			width: childContainer.width(),
			height: childContainer.height()
		};
	}
	
</script>
</head>
<body>
<div id='container'></div>
</body>
</html>