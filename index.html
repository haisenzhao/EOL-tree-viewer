<!DOCTYPE html>
<html>
<head>
<title>EOL Treemap</title>

<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link type="text/css" rel="stylesheet" media="all" href="css/layout.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/detail.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/treemap.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script src="js/lib/jit.js"></script>
<script src="js/lib/jquery.ba-hashchange.js"></script>
<script src="js/lib/jQuery_mousewheel_plugin.js"></script>
<script src="js/lib/jscolor/jscolor.js"></script>
<script src="js/eolapi.js"></script>
<script src="js/eoltreemap.js"></script>

</head>
<body>
<noscript>
  <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
    Your web browser must have JavaScript enabled
    in order for this application to display correctly.
  </div>
</noscript>

<div id='thejit'></div>
<div id='right'>
<ul id='tabs'>
	<li><a class='tab' href='#detail'>Detail</a></li>
	<li><a class='tab' href='#statistics'>Stats</a></li>
	<li><a class='tab' href='#search'>Search</a></li>
	<li><a class='tab' href='#options'>Options</a></li>
	<li><a class='tab' href='#help'>Help</a></li>
</ul>
<div id='detail'>Hold the F key to freeze this panel<h1 id="detail-title"></h1><h2 id="detail-subtitle"></h2><figure><div class=image></div><figcaption></figcaption></figure><div class='description'><h2></h2><div></div></div></div>
<div id='statistics'><ul><li>descendants:<span id='total_descendants'></span></li><ul><li>descendants with text:<span id='total_descendants_with_text'></span></li><li>descendants with images:<span id='total_descendants_with_images'></span></li></ul><li>text</li><ul><li>trusted text:<span id='total_trusted_text'></span></li><li>unreviewed text:<span id='total_unreviewed_text'></span></li></ul><li>images</li><ul><li>trusted images:<span id='total_trusted_images'></span></li><li>unreviewed images:<span id='total_unreviewed_images'></span></li></ul></ul></div>
<div id='search'><form onsubmit="return false;">Name: <input type='text' name='name'/></form>Matches on current page:<ul id='current-page-results'></ul></div>
<div id='options'></div>
<div id='help'>[Help text]</div>;
</div>

<script>
$(document).ready(function() {
	//TODO update right panel div sizes to fit remaining height after tabs
	
	var tm = new EOLTreeMap(jQuery("#thejit")[0]);
	jQuery("#help").html(EOLTreeMap.help);
	jQuery("#options").append(tm.optionsForm());
	
	jQuery(window).bind( 'hashchange', function(){
		if (location.hash) {
			tm.view(location.hash.slice(1));
		} else {
			location.hash = "COL"; //By default redirect to the CoL
		}
	});
	jQuery(window).trigger( 'hashchange' );
	
	tm.addViewChangeHandler(function (node) {
		document.title = tm.shownTree.name;
		jQuery("#search input[name='name']").keyup(); //trigger a search for the current search term
	});
	
	tm.addNodeSelectHandler(function (node) {
		var language = "en";
		
		jQuery("#detail-title").empty();
		jQuery("#detail-subtitle").empty();
		jQuery("#detail figure div.image").empty();
		jQuery("#detail figure figcaption").empty();
		jQuery("#detail div.description h2").empty();
		jQuery("#detail div.description div").empty();
		
		if (node != null) {
			jQuery("#detail-title").html(node.name);

			if(node.vernacularNames) {
				var commonName = jQuery.grep(node.vernacularNames, function (element) {
					return element.language === language;
				})[0];
				
				if (commonName) {
					jQuery("#detail-subtitle").html(commonName.vernacularName);
				}
			}	

			if (node.image) {
				var url = node.image.eolMediaURL || node.image.mediaURL;
				jQuery("#detail figure div.image").html("<img src=" + url + ">");
				//jQuery("#detail figure figcaption").html(node.image.taxonConcepts[0].scientificName); //TODO get the full dataobject and use the taxonConcept for the caption.  also, pick the taxonConcept for the current hierarchy, instead of just using the first one
				jQuery("#detail figure figcaption").html(node.image.title);
			}
			
			if (node.text) {
				if (node.text.agents) {
					var providers = jQuery.grep(node.text.agents, function (agent){
						return agent.role === "provider";
					});
					if (providers[0]) {
						jQuery("#detail div.description h2").html("From " + providers[0].full_name + ":");
					}
					
				}
				var description = node.text.description.replace(/&nbsp;/gm, " "); //remove ugly whitespace (Animal Diversity Web content, for example)
				jQuery("#detail div.description div").html(description);
			} else if (node.taxonConceptID && node.apiContentFetched) {
				var addTextURL = "http://www.eol.org/pages/" + node.taxonConceptID;
				jQuery("#detail div.description div").html("No general description is available. <a href='" + addTextURL + "' target='_blank' >Click here</a> to visit this page on the EOL and then click \"Add New Content\" to contribute an overview to this page.");
			}
		}
	});
	
	tm.addNodeSelectHandler(function (node) {
		//note: adding 1 to node.total_descendants everywhere because node.total_descendants_with_text and total_descendants_with_images include the node itself.
		if (node != null) {
			if (node.total_descendants) {
				jQuery('#total_descendants').text(node.total_descendants + 1);
				
				node.total_descendants_with_text && jQuery('#total_descendants_with_text').text(node.total_descendants_with_text).append(" (" + Math.round(100 * node.total_descendants_with_text / (node.total_descendants + 1)) + "%)");
				node.total_descendants_with_images && jQuery('#total_descendants_with_images').text(node.total_descendants_with_images).append(" (" + Math.round(100 * node.total_descendants_with_images / (node.total_descendants + 1)) + "%)");
			} else {
				jQuery('#total_descendants').empty();
				jQuery('#total_descendants_with_text').empty();
				jQuery('#total_descendants_with_images').empty();
			}
			
			(node.total_trusted_text && jQuery('#total_trusted_text').text(node.total_trusted_text)) || jQuery('#total_trusted_text').empty();
			(node.total_unreviewed_text && jQuery('#total_unreviewed_text').text(node.total_unreviewed_text)) || jQuery('#total_unreviewed_text').empty();
			(node.total_trusted_images && jQuery('#total_trusted_images').text(node.total_trusted_images)) || jQuery('#total_trusted_images').empty();
			(node.total_unreviewed_images && jQuery('#total_unreviewed_images').text(node.total_unreviewed_images)) || jQuery('#total_unreviewed_images').empty();
		}
	});
	
	                
    jQuery("#thejit").mousewheel(function(objEvent, intDelta){
		jQuery("#detail")[0].scrollTop -= 10*intDelta;
    });

    jQuery("#search input[name='name']").keyup(function (event) {
		jQuery(".treemap-container div").removeClass("highlight");
		jQuery("#current-page-results").empty();

		var searchbox = this;

		//selects any head div except the top level one with the breadcrumbs, then filters by name
		var matches = jQuery(".treemap-container > div.content > div.body div.head").filter(function () {
			return searchbox.value && jQuery(this).text().toLowerCase().indexOf(searchbox.value.toLowerCase()) >= 0;
		});

		matches.addClass("highlight");
		matches.each(function () {
			jQuery("#current-page-results").append("<li><a href=#" + jQuery(this).closest("div.content")[0].id + ">" + jQuery(this).text() + "</a></li>");
		});
		//TODO wait a half second or so after user stops typing and do an EOL search.  Highlight any nodes that are ancestors of results.
		//TODO before the EOL search, maybe it would be worthwhile to find results in the local portion of the tree, so anything in current browser session is shown as a separate set of results
    });

	jQuery(window).resize(function() {
		tm.view(null);
		//TODO update right panel div sizes to fit remaining height
	});

	var rightpages = jQuery("#right > div");
	var tabs = jQuery("#right .tab");
	
	tabs.click(function () {
		tabs.removeClass("selected");
		jQuery(this).addClass("selected");
		rightpages.hide().filter(this.hash).show();
		return false;
	});
	tabs.filter(":first").click();

});
</script>

</body>
</html>