<!DOCTYPE html>
<html>
<head>
<title>EOL Treemap</title>

<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link type="text/css" rel="stylesheet" media="all" href="css/layout.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/detail.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/treemap.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script src="js/lib/jit.js"></script>
<script src="js/lib/jquery.ba-hashchange.js"></script>
<script src="js/lib/jQuery_mousewheel_plugin.js"></script>
<script src="js/lib/jscolor/jscolor.js"></script>
<script src="js/taxon.js"></script>
<script src="js/controller.js"></script>
<script src="js/eolapi.js"></script>
<script src="js/eoltreemap.js"></script>

</head>
<body>
<noscript>
  <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
    Your web browser must have JavaScript enabled
    in order for this application to display correctly.
  </div>
</noscript>

<div id='thejit'></div>
<div id='right'>
<ul id='tabs'>
	<li><a class='tab' href='#detail'>Detail</a></li>
	<li><a class='tab' href='#statistics'>Stats</a></li>
	<li><a class='tab' href='#search'>Search</a></li>
	<li><a class='tab' href='#options'>Options</a></li>
	<li><a class='tab' href='#help'>Help</a></li>
</ul>
<div id='detail'>Hold the F key to freeze this panel<h1 id="detail-title"></h1><h2 id="detail-subtitle"></h2><figure><div class=image></div><figcaption></figcaption></figure><div class='description'><h2></h2><div></div></div></div>
<div id='statistics'><ul><li>descendants:<span id='total_descendants'></span></li><ul><li>descendants with text:<span id='total_descendants_with_text'></span></li><li>descendants with images:<span id='total_descendants_with_images'></span></li></ul><li>text</li><ul><li>trusted text:<span id='total_trusted_text'></span></li><li>unreviewed text:<span id='total_unreviewed_text'></span></li></ul><li>images</li><ul><li>trusted images:<span id='total_trusted_images'></span></li><li>unreviewed images:<span id='total_unreviewed_images'></span></li></ul></ul></div>
<div id='search'><form onsubmit="return false;">Name: <input type='text' name='query'/></form><div id='search-results'></div></div>
<div id='options'></div>
<div id='help'>[Help text]</div>;
</div>

<script>
$(document).ready(function() {
	//TODO update right panel div sizes to fit remaining height after tabs
	
	var tm = new EOLTreeMap(jQuery("#thejit")[0]);
	jQuery("#help").html(EOLTreeMap.help);
	jQuery("#options").append(tm.getOptionsForm());
	
	jQuery(window).bind( 'hashchange', function(){
		if (location.hash) {
			tm.view(location.hash.slice(1));
		} else {
			location.hash = "COL"; //By default redirect to the CoL
		}
	});
	jQuery(window).trigger( 'hashchange' );
	
	tm.addViewChangeHandler(function (node) {
		document.title = tm.shownTree.name;
		jQuery("#search input[name='name']").keyup(); //trigger a search for the current search term
	});
	
	tm.addNodeSelectHandler(function (node) {
		var language = "en";
		
		jQuery("#detail-title").empty();
		jQuery("#detail-subtitle").empty();
		jQuery("#detail figure div.image").empty();
		jQuery("#detail figure figcaption").empty();
		jQuery("#detail div.description h2").empty();
		jQuery("#detail div.description div").empty();
		
		if (node != null) {
			jQuery("#detail-title").html(node.name);

			if(node.vernacularNames) {
				var commonName = jQuery.grep(node.vernacularNames, function (element) {
					return element.language === language;
				})[0];
				
				if (commonName) {
					jQuery("#detail-subtitle").html(commonName.vernacularName);
				}
			}	

			if (node.image) {
				var url = node.image.eolMediaURL || node.image.mediaURL;
				jQuery("#detail figure div.image").html("<img src=" + url + ">");
				//jQuery("#detail figure figcaption").html(node.image.taxonConcepts[0].scientificName); //TODO get the full dataobject and use the taxonConcept for the caption.  also, pick the taxonConcept for the current hierarchy, instead of just using the first one
				jQuery("#detail figure figcaption").html(node.image.title);
			}
			
			if (node.text) {
				if (node.text.agents) {
					var providers = jQuery.grep(node.text.agents, function (agent){
						return agent.role === "provider";
					});
					if (providers[0]) {
						jQuery("#detail div.description h2").html("From " + providers[0].full_name + ":");
					}
					
				}
				var description = node.text.description.replace(/&nbsp;/gm, " "); //remove ugly whitespace (Animal Diversity Web content, for example)
				jQuery("#detail div.description div").html(description);
			} else if (node.taxonConceptID && node.apiContentFetched) {
				var addTextURL = "http://www.eol.org/pages/" + node.taxonConceptID;
				jQuery("#detail div.description div").html("No general description is available. <a href='" + addTextURL + "' target='_blank' >Click here</a> to visit this page on the EOL and then click \"Add New Content\" to contribute an overview to this page.");
			}
		}
	});
	
	tm.addNodeSelectHandler(function (node) {
		//note: adding 1 to node.total_descendants everywhere because node.total_descendants_with_text and total_descendants_with_images include the node itself.
		if (node != null) {
			if (node.total_descendants) {
				jQuery('#total_descendants').text(node.total_descendants + 1);
				
				node.total_descendants_with_text && jQuery('#total_descendants_with_text').text(node.total_descendants_with_text).append(" (" + Math.round(100 * node.total_descendants_with_text / (node.total_descendants + 1)) + "%)");
				node.total_descendants_with_images && jQuery('#total_descendants_with_images').text(node.total_descendants_with_images).append(" (" + Math.round(100 * node.total_descendants_with_images / (node.total_descendants + 1)) + "%)");
			} else {
				jQuery('#total_descendants').empty();
				jQuery('#total_descendants_with_text').empty();
				jQuery('#total_descendants_with_images').empty();
			}
			
			(node.total_trusted_text && jQuery('#total_trusted_text').text(node.total_trusted_text)) || jQuery('#total_trusted_text').empty();
			(node.total_unreviewed_text && jQuery('#total_unreviewed_text').text(node.total_unreviewed_text)) || jQuery('#total_unreviewed_text').empty();
			(node.total_trusted_images && jQuery('#total_trusted_images').text(node.total_trusted_images)) || jQuery('#total_trusted_images').empty();
			(node.total_unreviewed_images && jQuery('#total_unreviewed_images').text(node.total_unreviewed_images)) || jQuery('#total_unreviewed_images').empty();
		}
	});
	
	                
    jQuery("#thejit").mousewheel(function(objEvent, intDelta){
		jQuery("#detail")[0].scrollTop -= 10*intDelta;
    });

	jQuery("#search").submit(function () {
		var query = jQuery("#search input").val();
		if (query) {
			jQuery("#search-results").html("<img src='images/ajax-loader.gif' />");
			
			//a function for filtering taxonConcepts below
			var nameAccordingTo = tm.currentHierarchyName();
			var hierarchyMatch = function (taxonConcept) {
				return taxonConcept.nameAccordingTo === nameAccordingTo;
			};
			
			var api = new EolApi();
			api.searchHierarchyEntries(query, function (json) {
				jQuery("#search-results").empty();
				var thisClassificationMsg = jQuery("<div>").text("No results found in the current classification").appendTo("#search-results");
				var thisClassificationResults = jQuery("<ul>").appendTo("#search-results");
				var otherClassificationMsg = jQuery("<div>").text("No results found in other classifications").appendTo("#search-results");
				var otherClassificationResults = jQuery("<ul>").appendTo("#search-results");
				var hoverDetails = jQuery("<div id='search-result-details'>").appendTo("#search-results");
				
				jQuery.each(json.results, function (index, result) {
					var match = jQuery.grep(result.page.taxonConcepts, hierarchyMatch);
					var item;

					var hoverIn = function (eventObject) {
						hoverDetails.html("<h3>Content matched:</h3>").append(result.content);
						hoverDetails.show();
					};

					var hoverOut = function (eventObject) {
						hoverDetails.hide();
					};

					if (match.length > 0) {
						thisClassificationResults.show();
						thisClassificationMsg.html("<h3>Results in the current classification:</h3>");
						var link = jQuery("<a href=#" + match[0].identifier + ">" + match[0].scientificName + "</a>");
						item = jQuery("<li class='same-classification-result'>").append(link).appendTo(thisClassificationResults);

					}
					else if (result.page.taxonConcepts && result.page.taxonConcepts.length > 0)
					{
						otherClassificationResults.show();
						otherClassificationMsg.html("<h3>Results in other classifications:</h3>");
						item = jQuery("<li class='other-result'>").append(result.title).appendTo(otherClassificationResults);
						var links = jQuery("<ul>").appendTo(item);
						jQuery.each(result.page.taxonConcepts, function(index, taxonConcept) {
							links.append("<li><a href=#" + taxonConcept.identifier + ">" + taxonConcept.nameAccordingTo + "</a></li>");
						});
					}

					if (item) {
						item.hover(hoverIn, hoverOut);
					}
				});
			});
		}
	});

	jQuery(window).resize(function() {
		tm.view(null);
		//TODO update right panel div sizes to fit remaining height
	});

	var rightpages = jQuery("#right > div");
	var tabs = jQuery("#right .tab");
	
	tabs.click(function () {
		tabs.removeClass("selected");
		jQuery(this).addClass("selected");
		rightpages.hide().filter(this.hash).show();
		return false;
	});
	tabs.filter(":first").click();

});
</script>

</body>
</html>