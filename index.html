<!DOCTYPE html>
<html>
<head>
<title>EOL Treemap</title>

<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link type="text/css" rel="stylesheet" media="all" href="css/layout.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/detail.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/treemap.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script src="js/lib/jit.js"></script>
<script src="js/lib/jquery.ba-hashchange.js"></script>
<script src="js/lib/jQuery_mousewheel_plugin.js"></script>
<script src="js/eolapi.js"></script>
<script src="js/eoltreemap.js"></script>

</head>
<body>
<noscript>
  <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
    Your web browser must have JavaScript enabled
    in order for this application to display correctly.
  </div>
</noscript>

<div id='thejit'></div>
<div id='jitdetail'><div class='title'></div><figure><div class=image></div><figcaption></figcaption></figure><div class='description'><h2></h2><div></div></div></div>
<!-- TODO: add a search box -->
<!-- TODO handle resize -->

<script>
$(document).ready(function() {
	var tm = new EOLTreeMap(jQuery("#thejit")[0]);
	
	$(window).bind( 'hashchange', function(){
		if (location.hash) {
			tm.view(location.hash.slice(1));
		} else {
			location.hash = 24974884; //By default redirect to Animalia in the CoL
		}
	});
	$(window).trigger( 'hashchange' );
	
	tm.addViewChangeHandler(function (node) {
		document.title = tm.shownTree.name;
	});
	
	tm.addNodeSelectHandler(function (node) {
		jQuery("#jitdetail div.title").empty();
		jQuery("#jitdetail figure div.image").empty();
		jQuery("#jitdetail figure figcaption").empty();
		jQuery("#jitdetail div.description h2").empty();
		jQuery("#jitdetail div.description div").empty();
		
		if (node != null) {
			jQuery("#jitdetail div.title").html(node.name);
			if (node.image) {
				var url = node.image.eolMediaURL || node.image.mediaURL;
				jQuery("#jitdetail figure div.image").html("<img src=" + url + ">");
				//jQuery("#jitdetail figure figcaption").html(node.image.taxonConcepts[0].scientificName); //TODO get the full dataobject and use the taxonConcept for the caption.  also, pick the taxonConcept for the current hierarchy, instead of just using the first one
				jQuery("#jitdetail figure figcaption").html(node.image.title);
			}
			
			if (node.text) {
				if (node.text.agents) {
					var providers = jQuery.grep(node.text.agents, function (agent){
						return agent.role === "provider";
					});
					if (providers[0]) {
						jQuery("#jitdetail div.description h2").html("From " + providers[0].full_name + ":");
					}
					
				}
				var description = node.text.description.replace(/&nbsp;/gm, " "); //remove ugly whitespace (Animal Diversity Web content, for example)
				jQuery("#jitdetail div.description div").html(description);
			}
		}
	});
	
	                
    $("#thejit").mousewheel(function(objEvent, intDelta){
		jQuery("#jitdetail")[0].scrollTop -= 10*intDelta;
    });
	
	$(window).resize(function() {
		tm.view(null);
	});

});
</script>

</body>
</html>