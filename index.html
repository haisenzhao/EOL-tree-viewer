<!DOCTYPE html>
<html>
<head>
<title>EOL Treemap</title>

<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link type="text/css" rel="stylesheet" media="all" href="css/layout.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/detail.css" />
<link type="text/css" rel="stylesheet" media="all" href="css/treemap.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script src="js/lib/jit.js"></script>
<script src="js/lib/jquery.ba-hashchange.js"></script>
<script src="js/lib/jQuery_mousewheel_plugin.js"></script>
<script src="js/eolapi.js"></script>
<script src="js/eoltreemap.js"></script>

</head>
<body>
<noscript>
  <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
    Your web browser must have JavaScript enabled
    in order for this application to display correctly.
  </div>
</noscript>

<div id='thejit'></div>
<div id='right'>
<ul id='tabs'>
	<li><a class='tab' href='#jitdetail'>Detail</a></li>
	<li><a class='tab' href='#search'>Search</a></li>
	<li><a class='tab' href='#options'>Options</a></li>
	<li><a class='tab' href='#help'>Help</a></li>
</ul>
<div id='jitdetail'>Hold the F key to freeze this panel<div class='title'></div><figure><div class=image></div><figcaption></figcaption></figure><div class='description'><h2></h2><div></div></div></div>
<div id='search'><form>Name: <input type='text' name='name'/></form>Matches on current page:<ul id='current-page-results'></ul></div>
<div id='options'>[Not yet implemented]</div>
<div id='help'>[Help text]</div>;
</div>
<!-- TODO: add a search box -->
<!-- TODO handle resize -->

<script>
$(document).ready(function() {
	//TODO update right panel div sizes to fit remaining height after tabs
	
	var tm = new EOLTreeMap(jQuery("#thejit")[0]);
	jQuery("#help").html(EOLTreeMap.help);
	
	jQuery(window).bind( 'hashchange', function(){
		if (location.hash) {
			tm.view(location.hash.slice(1));
		} else {
			location.hash = 24974884; //By default redirect to Animalia in the CoL
		}
	});
	jQuery(window).trigger( 'hashchange' );
	
	tm.addViewChangeHandler(function (node) {
		document.title = tm.shownTree.name;
		jQuery("#search input[name='name']").keyup(); //trigger a search for the current search term
	});
	
	tm.addNodeSelectHandler(function (node) {
		jQuery("#jitdetail div.title").empty();
		jQuery("#jitdetail figure div.image").empty();
		jQuery("#jitdetail figure figcaption").empty();
		jQuery("#jitdetail div.description h2").empty();
		jQuery("#jitdetail div.description div").empty();
		
		if (node != null) {
			jQuery("#jitdetail div.title").html(node.name);
			if (node.image) {
				var url = node.image.eolMediaURL || node.image.mediaURL;
				jQuery("#jitdetail figure div.image").html("<img src=" + url + ">");
				//jQuery("#jitdetail figure figcaption").html(node.image.taxonConcepts[0].scientificName); //TODO get the full dataobject and use the taxonConcept for the caption.  also, pick the taxonConcept for the current hierarchy, instead of just using the first one
				jQuery("#jitdetail figure figcaption").html(node.image.title);
			}
			
			if (node.text) {
				if (node.text.agents) {
					var providers = jQuery.grep(node.text.agents, function (agent){
						return agent.role === "provider";
					});
					if (providers[0]) {
						jQuery("#jitdetail div.description h2").html("From " + providers[0].full_name + ":");
					}
					
				}
				var description = node.text.description.replace(/&nbsp;/gm, " "); //remove ugly whitespace (Animal Diversity Web content, for example)
				jQuery("#jitdetail div.description div").html(description);
			}
		}
	});
	
	                
    jQuery("#thejit").mousewheel(function(objEvent, intDelta){
		jQuery("#jitdetail")[0].scrollTop -= 10*intDelta;
    });

    jQuery("#search input[name='name']").keyup(function (event) {
		jQuery(".treemap-container div").removeClass("highlight");
		jQuery("#current-page-results").empty();

		var searchbox = this;

		//selects any head div except the top level one with the breadcrumbs, then filters by name
		var matches = jQuery(".treemap-container > div.content > div.body div.head").filter(function () {
			return searchbox.value && jQuery(this).text().toLowerCase().indexOf(searchbox.value.toLowerCase()) >= 0;
		});

		matches.addClass("highlight");
		matches.each(function () {
			jQuery("#current-page-results").append("<li><a href=#" + jQuery(this).closest("div.content").id + ">" + jQuery(this).text() + "</a></li>");
		});
		//TODO wait a half second or so after user stops typing and do an EOL search.  Highlight any nodes that are ancestors of results.
		//TODO before the EOL search, maybe it would be worthwhile to find results in the local portion of the tree, so anything in current browser session is shown as a separate set of results
    });

	jQuery(window).resize(function() {
		tm.view(null);
		//TODO update right panel div sizes to fit remaining height
	});

	var rightpages = jQuery("#right > div");
	var tabs = jQuery("#right .tab");
	
	tabs.click(function () {
		tabs.removeClass("selected");
		jQuery(this).addClass("selected");
		rightpages.hide().filter(this.hash).show();
		return false;
	});
	tabs.filter(":first").click();

});
</script>

</body>
</html>